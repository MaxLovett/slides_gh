---
title: "研究数据与分析收集原则"
subtitle: "Learning DGP for Big-Data Research with Dr. Hu"
author: "胡悦"
# date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    self_contained: FALSE
    chakra: libs/remark-latest.min.js
    css: 
      - default
      - zh-CN_custom.css
      - style_ui.css
    nature:
      highlightStyle: github
      highlightLines: true
      highlightSpans: true
      countIncrementalSlides: false
      ratio: 16:9
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, htmltools.dir.version = FALSE)

library(pacman)
p_load(icons, xaringanExtra)

use_xaringan_extra(c("tile_view", # O
                     "broadcast",
                     "panelset",
                     "tachyons",
                     "fit_screen"))

use_extra_styles(
  hover_code_line = TRUE,
  mute_unhighlighted_code = TRUE
)

# Functions preload
set.seed(313)
```

## 学习计划

.pull-left[
### 研究设计原则

1. 科学研究


### 数据收集原则

1. 抽样与权重
1. 变量测量
]

.pull-right[
### 数据分析原则

1. 统计基础
1. 重复性截面数据分析
1. 软件与数据资源
]

---

class: inverse, bottom

# 研究设计原则

---

class: middle, center, large

.navy[政]务大数据     
&sub; .navy[政]治.red[科学]研究   
&sub; 社会.red[科学]研究

--

### 科学从何谈起


1\. 程序    
2\. 方法

---

## 研究程序

.pull-left[
### 问题导向

1. .red[问题]提出
1. 理论.red[假设]
1. 数据.red[方法]
1. 实证.red[检验]
]

???

Jim Gray 早在2006 年就发表了题为《第四范式：数据密集型科学发现》：实验范式、理论范式、仿真范式、Data-Intensive Scientific Discovery

--

.pull-right[
### 数据导向

1. .red[观察]数据
1. .red[分析]方法
1. .red[规律]总结
1. 理论.red[提升]

]

---

class: middle, center

## 第一步：问题与理论

### 问题来源

梁文道 + 列文虎克 + 牛顿

???
文献

观察与发现

兴趣（对上帝的爱）

--

### 研究步骤

理论（一个想法）&rarr; 假设（几个判断）&rarr; 验证（一坨证据）

--

### 研究形式

1\. 描述    
2\. 机制


---

.pull-left[
### 描述

已知 &rArr; 未知

1. 无偏（正确😄）
1. 高效（准确😅）

<img src="images/stat_yangQian.gif" height = 300 />
]

.pull-right[
### 机制

搞清why & how

......

but how?

<img src="images/stat_yuXuanji.jfif" height = 300 />
]

---

## 关于因果机制的几个争议

.pull-left[
### 定义

+ 时间序列
    + 多重因果？
+ 条件角度
    + 决定论 vs. 概率论

.center[<img src="images/stat_bookOfWhy.jpg" height = 250 />]
]

--

.pull-right[

### 测量

Y ~ X vs.

Y ~ A &rarr; B  &rarr; C  &rarr; D &rarr; E &rarr; ... &rarr; X

]

---

## 关于因果机制的几个争议

.pull-left[
### 定义

+ 时间序列
    + 多重因果？
+ 条件角度
    + 决定论 vs. 概率论

.center[<img src="images/stat_bookOfWhy.jpg" height = 250 />]
]

.pull-right[

### 测量

Y ~ X vs.

Y ~ A &rarr; B  &rarr; C  &rarr; D &rarr; E &rarr; ... &rarr; X

### 观测

<img src="images/stat_correlation.png" height = 250 />
]

???

correlation doesn't imply causation

---

## 机制工具：

+ 反事实分析

--

这些都不是：

+ 方差分析
+ 非参数检验
+ 相关系数
+ 回归分析
+ Lasso
+ SEM
+ 倾向值匹配   
......

---

## Wrap Up

研究设计原则

1. 科学：程序 + 方法
1. 步骤：问题 + 理论 + 假设 + 验证
1. 形式：描述 and/or 机制

---

class: inverse, bottom

# 数据收集原则

---

class: center, middle

## 抽样与权重


“每日上亿条”

“全网数据”

“《人民日报》所有文章”

--

.Large[大数据亦要抽样。]

---

## 抽样

.center[从.blue[一大堆]到.red[一小撮] &rArr; 代表性]

???

随机抽样的代表性体现在一定的sample size上

--

.pull-left[
简单随机抽样

+ SHA算法和MD5
+ 计算机随机数
]

???

计算机伪随机数

真随机数：物理现象，如内存、硬件、噪音

--

.pull-right[

复杂抽样

*设计*

+ 配额设计（quota）
+ 分群设计（clustering）
+ 分层设计（stratification）

*矫正*

+ 有限总体校正（finite population corrections, FPC）
+ 不相等权重（unequal weights）
]

---

.center[
<img src="images/stat_stratifiedCluster.png" height = 500 width = 600 />
<img src="images/stat_quota.png" height = 500 width = 300 />
]

???

Stratification: 分类，每类中随机抽取，每类成员在总体中配比不变        
Clustering：直接随机抽取一类        
Quota：成分配比够就行，不用随机

---

## 常见设计

.pull-left[
* Strata + Weight (+ FPC)
      + PSU/SSU/TSU

PSU: primary sampling unit    
SSU: secondary sampling unit    
TSU: tertiary sampling unit

]
???

FPC is used when you sample without replacement from more than 5% of a finite population, leading to more uncertainty. 

当sampling 大于population的5%时使用

$FPC = \sqrt{(N-n)/(N-1)}$, 

N = population size   
n = sample size.

修正估计结果$s = \frac{\sigma}{\sqrt{n}}\sqrt{(N-n)/(N-1)}.$

--

.pull-right[
* Strata: 将人口根据某些特征分组；
    + 减少点估计的标准误；
    + 不同层抽样权重不等

* Sampling (survey) weight：
    + 样本入选概率的倒数；
    + 各抽样阶段权重的乘积；
    + 抽样权重在总体层面是等概率的，但在个体层面是非等概；影响点估计的计算
]

???

For example, if you have selected 200 goldfish out of a population of 1000, the reciprocal of the likelihood of being selected is 1000/200, so the sampling weight for the goldfish would be 5


---

## 后果

* Stratification &rarr; 层间方差不齐;
* Clustering &rarr; 群组间方差不齐，群组内不独立.
* Weighting &rarr; 某些特征分布与总体不一致;

--

.center[复杂抽样是.red[不得已而为之]]

--

## "后招"

Post-DGP correction &rarr; 把权重纳入分析

---

## 应用

[Behavioral Risk Factor Surveillance System (BRFSS) ](https://www.cdc.gov/brfss/smart/smart_2011.htm) 
County data by US Centers of Disease Control and Prevention (CDC)

```{r survey-example, include=FALSE, eval=FALSE}
brfss_11 <- Hmisc::sasxport.get("D:/Desktop/CNTY2011.xpt")

brfss_11 <- haven::read_sas("data/CNTY11_SASOUT.SAS")

library(car)

nams<-names(brfss_11)

#we see some names are lower case, some are upper and some have a little _ in the first position. This is a nightmare.
newnames <- gsub(pattern = "_",
                 replacement =  "",
                 x =  nams)
names(brfss_11) <- tolower(newnames)

#Poor or fair self rated health
brfss_11$badhealth <- ifelse(brfss_11$genhlth %in% c(4, 5), 1, 0)

#race/ethnicity
brfss_11$black <-
  recode(brfss_11$racegr2, recodes = "2=1; 9=NA; else=0")
brfss_11$white <-
  recode(brfss_11$racegr2, recodes = "1=1; 9=NA; else=0")
brfss_11$other <-
  recode(brfss_11$racegr2, recodes = "3:4=1; 9=NA; else=0")
brfss_11$hispanic <-
  recode(brfss_11$racegr2, recodes = "5=1; 9=NA; else=0")

#insurance
brfss_11$ins <- ifelse(brfss_11$hlthpln1 == 1, 1, 0)

#income grouping
brfss_11$inc <- ifelse(brfss_11$x.incomg == 9, NA, brfss_11$x.incomg)

#education level
brfss_11$educ <-
  recode(brfss_11$educa,
         recodes = "1:2='0Prim'; 3='1somehs'; 4='2hsgrad'; 5='3somecol'; 6='4colgrad';9=NA",
         as.factor = T)
brfss_11$educ <- relevel(brfss_11$educ, ref = '2hsgrad')

#employment
brfss_11$employ <-
  recode(brfss_11$employ,
         recodes = "1:2='Employed'; 2:6='nilf'; 7='retired'; 8='unable'; else=NA",
         as.factor = T)
brfss_11$employ <- relevel(brfss_11$employ, ref = 'Employed')

#marital status
brfss_11$marst <-
  recode(brfss_11$marital,
         recodes = "1='married'; 2='divorced'; 3='widowed'; 4='separated'; 5='nm';6='cohab'; else=NA",
         as.factor = T)
brfss_11$marst <- relevel(brfss_11$marst, ref = 'married')

#Age cut into intervals
brfss_11$agec <- cut(brfss_11$age, breaks = c(0, 24, 39, 59, 79, 99))

#BMI, in the brfss_11a the bmi variable has 2 implied decimal places, so we must divide by 100 to get real bmi's
brfss_11$bmi <- brfss_11$x.bmi5 / 100

library(dplyr)

brfss_11 <- select(brfss_11, badhealth, black, white, other, hispanic, ins, inc, educ, employ, marst, agec, bmi, x.ststr, x.cntywt) %>% 
  rename(ststr = x.ststr, cntywt = x.cntywt)

saveRDS(brfss_11, "data/brfss_11.Rds")
```

Set the survey conditions

```{r survey-analysis}
brfss_11 <- readRDS("data/brfss_11.Rds")

library(survey)

options(survey.lonely.psu = "adjust")

des <-
  svydesign(
    ids =  ~ 1,
    strata =  ~ ststr,
    weights =  ~ cntywt,
    data = brfss_11[is.na(brfss_11$cntywt) == F, ] # non-missing case weights
  )
```

---

Descriptive

```{r descriptive}
library(questionr)

prop.table(wtd.table(brfss_11$badhealth, brfss_11$educ, weights = brfss_11$cntywt), margin=2)

prop.table(table(brfss_11$badhealth, brfss_11$educ), margin=2)
```

---

Analysis

```{r survey-ols}
raw<-lm(bmi~educ+agec, data=brfss_11)
freqW<-lm(bmi~educ+agec, data=brfss_11, weights = cntywt)
surveyW<-svyglm(bmi~educ+agec,des, family=gaussian)
```

```{r survey-ols-plot, echo = FALSE, out.height="100%", fig.align='center'}
library(dotwhisker)
dwplot(list(NoWeight = raw, FreqWeight = freqW, SurveyWeight = surveyW)) + 
  theme_minimal()
```


???

survey weight is using the inverse-probability weighting

---

## Wrap Up

+ 代表性 &rarr；抽样
    + 简单抽样
    + 复杂抽样
+ 复杂抽样步骤
    + 分配额/层/群
    + 抽
    + 权重
+ 复杂抽样分析：考虑权重

---

class: inverse, bottom

# 数据分析原则

---

class: center, middle

.Large[统计学 vs. 计量经济学]   
.Large[Statistics vs. Econometrics]

???

结果准

方向对

---

## 统计学

.pull-left[
*分类I*

* 理论统计学
* 应用统计学


*分类II*

* 描述统计
* 推断统计
]

???

研究统计学的一般理论；研究统计方法的数学原理

研究统计方法在具体领域中的应用

--

.pull-right[
*功能*

.center[<img src="images/stat_statProcess.png" height = 350 />]
]

---

## 统计学常用概念

.center[<img src="images/stat_concepts.png" height = 450 />]

---

.pull-left[

### DGP

总体 vs. 样本

抽样误差

### 分析

参数 vs. 系数

期望

不确定性

]



???
* 总体：在理论上明确界定的个体全部集合。
* 样本：从总体中按照一定规则和程序抽出来的个体的集合，是总体一个子集。


* 抽样误差: 用样本的统计值去推算总体的参数值时总会有差异，这个差异就是抽样误差。


* 参数：概括总体特征的测度值。
* 系数（统计量）：概括样本特征的测度值。

* 期望值: $E(X) = \sum Xp$
* 不可确定性： 描述数据的离散趋势
    + Variance: $\sigma^2 = \sum(X - \mu)^2p(X)$
    + Standard deviation: $\sigma$

--

.pull-right[

### 材料

* 数据
* .red[变量]、变量值、缺失值

### 测量

+ 定类
+ 定序
+ 定距
+ 定比
]

???

1. 定类：每一种不同的数字或符号代表着不同的类别或标记。定类数据只有类别属性之分， 无大小、程度之分。

1. 定序：每一种数字或符号代表着事物的等级大小、高低、先后的次序。

1. 定距：每一种数字或符号代表着事物的量的间距。定距数据没有绝对的零点，例如，温度、智商，其中的“零”只是一个相对位置，不代表“没有”。

1. 定比：每一种数字或符号代表着事物的所有算术特征。其取值除了具有类别、次序、间距的属性以外，还可以构成一个有意义的比率，其中的“零” 表示真正的“一无所有” 。


例子：

feeling thermometer: 0-200，冷淡到热情, 0是非常极端的情绪，不代表没有
-100-0-100， 0代表0的意思，ratio 是唯一一种scale可以表示meaningful ratio

在-100-0-100，按10，30 （1：3）取值，放回0-200，110:130, 不是ratio

---

## 练习

研究者想了解全市居民上个月的平均通讯支出是多少元，为此随机抽取了1800个居民进行了访问，得到了这些居民上个月的平均通讯支出。

问题：总体、样本、参数、系数？

---

## 练习

“调查发现：人们对市政府工作的满意度，在不同年龄、教育水平、收入、职业，以 及不同户口人群中有显著的差异。”

问题：上述这段描述中提到了几个变量，分别是什么类型的数据？

---

## 测量类型

直接数据（Raw data）

--

整合变量（Aggregated data）

--

.red[潜在变量测量] (Latent measurement)

* .gray[经典：Factor analysis]
* .gray[新锐：IRT]
* 全面：SEM


---

class: small

## 结构方程模型

Tang, Wenfang, Yue Hu, and Shuai Jin. 2017. “Affirmative Inaction: Language Education and Labor Mobility among China’s Muslim Minorities.” *Chinese Sociological Review* 48(4): 346–66.

.center[<img src="images/stat_sem_eg.png" height = 400 />]

---

## 变量 &rarr; 很多变量

数据：

1. 变量（variables）
1. 观测层级 (unit of analysis)
1. 观测对象（observations）

---

## 结构化数据

Tidy version

.center[<img src="images/stat_tidydata.png" height = 200 />]

```{r tidy, echo = FALSE}
head(mtcars)
```

---

## 数据 &rarr; 很多数据

.pull-left[
*面板数据*

好

(yysy，成本高，样本局限大🙄
]
???

动态分析

对比性高

--

.pull-right[
*重复抽样数据*

* 周期性调查
* 每次随机
* 时序性信息

e.g., WVS, CGSS, GSS, .navy[DCPO datasets]


* 呈现社会、政治、经济现象的变化.red[趋势]
* 探索特定.red[人群(Cohort)]社会行为与态度的变迁模式
* 适用于识别.red[自然实验]的效应
]

---

## 数据分析

.pull-left[
.center[
*描述性分析*

+ 解读数据结构
+ 显示、理解变化趋势
]
]

--

.pull-right[
.center[
*比较分析*

+ 跨层级分析
+ 跨时间分析
+ 跨区域分析
]
]

--

.center[
*总体分析*

+ 对核心变量一般表现的衡量
+ 与比较分析不分先后
]

---

## 举例：不平等与“美国梦”

Solt, Frederick, Yue Hu, Kevan Hudson, et al. 2016. “Economic Inequality and Belief in Meritocracy in the United States.” Research & Politics 3(4): 1–7.


.left-column[
### 描述
]

.right-column[
.center[<img src="images/stat_threeMeasurements.png" height = 400 width = 600/>]
]

---

## 举例：不平等与“美国梦”

Solt, Frederick, Yue Hu, Kevan Hudson, et al. 2016. “Economic Inequality and Belief in Meritocracy in the United States.” Research & Politics 3(4): 1–7.


.left-column[
### 描述
### 总体
]

.right-column[
.center[<img src="images/stat_gini.png" height = 400 width = 600/>]
]



---
## 举例：不平等与“美国梦”

Solt, Frederick, Yue Hu, Kevan Hudson, et al. 2016. “Economic Inequality and Belief in Meritocracy in the United States.” Research & Politics 3(4): 1–7.


.left-column[
### 描述
### 总体
### 比较
]

.right-column[
.center[<img src="images/stat_pp.png" height = 400 width = 600/>]
]


---

## 举例：爱国主义教育基地

.pull-left[
*描述分析*

.center[<img src="images/stat_patrioBase9705.gif" height = 400 width = 600/>]
]

.pull-right[
*总体比较分析*

.center[<img src="images/stat_loyal.png" height = 400 width = 600/>]
]

---

## 数据分析工具

* 分析软件：STATA, SAS, SPSS, EXCEL
* 程序语言：R, Python, JAVA, C++

---

## Wrap Up

统计/计量功能

变量
+ 测量级别
+ 测量手段

数据（tidy version）

面板数据/重复抽样数据

数据分析工具

```{r pdfPrinting, eval = FALSE, include = FALSE}
pagedown::chrome_print(list.files(pattern = "01_.*.html"), 
                       timeout = 500, 
                       box_model = "padding")
```