---
title: "Dr. Hu's R Workshop"
output: 
  learnr::tutorial:
    progressive: true
    allow_skip: true
runtime: shiny_prerendered
---


```{r setup, include=FALSE}
library(learnr)
library(tidyverse)
library(gapminder)
```

# Lecture II: Data Munging

## Preface

* R basics
* **Data manipulation**
* Statistical/econometric analysis
* Data visualization
* Reproduction

## Toy Data

Demographic statistics popularized by [Hans Rosling's TED talks](https://www.ted.com/talks/hans_rosling_shows_the_best_stats_you_ve_ever_seen?utm_campaign=tedspread--b&utm_medium=referral&utm_source=tedcomshare).

```{r toy, exercise = TRUE}
library(gapminder)
gapminder
```

## General Way

### What you can do

1. Glimpse the data
1. Create, copy, or delete a variable
1. Replace values 

### General rule

1. Variable -> vector;
2. Conditional replacement;
3. Use functions.

```{r tradition, exercise = TRUE}
## Glimpse the data
head(gapminder, n = 5)
str(gapminder)
```

```{r tradition-solution}
# $, class, table, unique
gapminder$year2 <- gapminder$year
gapminder$year2[gapminder$year2 == 1952] <- 2052
gapminder$year2 <- NULL

mean(gapminder$year, na.rm = TRUE)
median(gapminder$year)
min(gapminder$year)
max(gapminder$year)
length(gapminder$year)
unique(gapminder$year)
table(gapminder$year)
class(gapminder$gdpPercap)
typeof(gapminder$gdpPercap)
class(gapminder$continent)
levels(gapminder$continent)
summary(gapminder$year)
descr::freq(gapminder$year)
```

## Tidyverse

* Prevalent toolkid for data manipulation 
    + Hadley Wickman and the Rstudio team. 
    + [A series of packages](https://www.tidyverse.org/packages/) 
    + Loading the packages first
        + `library(tidyverse)` =  `ggplot2`, `dplyr`, `tidyr`, `readr`, `purrr`, and `tibble`.

```{r loadTidy, exercise = TRUE}
## install.packages("tidyverse")
library("tidyverse")
```


### A Glimpse of `tidyverse` Functions

They do one thing, and they do it well.

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/simple.png")
```

### Composable `tidyverse`

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/composable.png")
```

Making codes more readable.

Shortcut for `%>%`: 

* Ctrl + Shift + M (Win)
* Cmd + Shift + M (Mac)

## Single Variable Manipulation

### A Glimpse of the Data

```{r overview, exercise = TRUE}
glimpse(gapminder)
```

### Data properties

```{r dataProp, exercise = TRUE}
names(gapminder)
# nrow(gapminder)
# ncol(gapminder)
# str(gapminder)
```

### Variable properties

```{r varProp, exercise = TRUE}
summary(gapminder$year)
# mean(gapminder$year, na.rm = TRUE)
# median(gapminder$year)
# min(gapminder$year)
# max(gapminder$year)
# length(gapminder$year)
# unique(gapminder$year)
# table(gapminder$year)
# descr::freq(gapminder$year)
# class(gapminder$gdpPercap)
# typeof(gapminder$gdpPercap)
# class(gapminder$continent)
# levels(gapminder$continent)
```

### Variable manipulation

```{r varChange}
gapminder$year_bu <- gapminder$year
```

* Changing a single value (rarely used)

Let's change the second element of variable `year` to "1956."

```{r singleValue, exercise = TRUE}
gapminder$year[2]
```

* Changing values based on conditions

Let's add a hundred years to every year recorded under "China."

```{r conditionChange, exercise = TRUE}
summary(gapminder$year[gapminder$country == "China"])
```

Is there a way avoiding typing the brackets so many times? 

* Delete a variable

```{r delete, exercise = TRUE}
gapminder$year <- NA
```

* Create a variable

```{r create, exercise = TRUE}
gapminder$year
```


## Within-Dataset Manipulation

### Ordering the Data

Q: Which countries have the largest populations?

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/arrange.png")
```

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/desc.png")
```

```{r ex4, exercise = TRUE, exercise.eval = TRUE}
gapminder
```

```{r ex4-solution}
arrange(gapminder, desc(pop))
```

### Conditioning

Q: Which countries had the largest population in *2007*?

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/filter.png")
```

```{r ex6, exercise = TRUE, exercise.eval = TRUE}
gapminder
```

```{r ex6-solution}
gapminder2007 <- filter(gapminder, year == 2007)
arrange(gapminder2007, desc(pop))

gapminder %>% 
  filter(year == 2007) %>% 
  arrange(desc(pop))
```

### Extracting

Q: What's the life expectancy of the country that had the largest population in 2007?

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/select.png")
```

```{r ex7, exercise = TRUE, exercise.eval = TRUE}
gapminder
```

```{r ex7-solution}
gapminder %>% 
  filter(year == 2007) %>% 
  arrange(desc(pop)) %>% 
  select(country, pop, lifeExp)
```

### Modification

Q: What is the gdp of each country?

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/mutate.png")
```

```{r ex8, exercise = TRUE, exercise.eval = TRUE}
gapminder
```

```{r ex8-solution}
gapminder %>% 
  mutate(gdp = pop * gdpPercap) %>% 
    select(country, pop, gdpPercap, gdp)
```


### Summarising

Q: What was the average gdp?

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/summarise.png")
```

```{r ex9, exercise = TRUE, exercise.eval = TRUE}
gapminder %>% 
  mutate(gdp = pop * gdpPercap)
```

```{r ex9-solution}
gapminder %>% 
  mutate(gdp = pop * gdpPercap, mean_gdp = mean(gdp)) %>% 
  select(country, gdp, mean_gdp)

gapminder %>% 
  mutate(gdp = pop * gdpPercap) %>% 
  summarise(mean_gdp = mean(gdp))
```

### Clustering

Q: What was the average gdp for each year?

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/group_by.png")
```

```{r ex10, exercise = TRUE, exercise.eval = TRUE}
gapminder %>% 
  mutate(gdp = pop * gdpPercap) %>% 
  summarise(mean_gdp = mean(gdp))
```

```{r ex10-solution}
gapminder %>% 
  mutate(gdp = pop * gdpPercap) %>% 
  group_by(year) %>% 
  summarise(mean_gdp = mean(gdp))
```

### Important note

When doing `gapminder %>% ...`, you are <span style="color:red">NOT</span> adding or changing anything of the `gapminder`.
If you want to save the changes, send the result to an object.

```{r eval = FALSE}
gapminderNew <- gapminder %>% ...
```

## Multi-dataset Manipulation

### Appending

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/rowbind.png")
```

### Combine 2002 and 2007 data

```{r ex11, exercise = TRUE, exercise.eval = TRUE}
gapminder2002 <- filter(gapminder, year == 2002)[1:2, ]
gapminder2007 <- filter(gapminder, year == 2007)[1:2, ]
```

```{r ex11-solution}
gapminder2002 <- filter(gapminder, year == 2002)[1:2, ]
gapminder2007 <- filter(gapminder, year == 2007)[1:2, ]

gapminder0207 <- bind_rows(gapminder2002, gapminder2007)
```

See also `bind_cols`.

### Merge

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/join.png")
```

### Create a dataset including both continent and year

```{r ex12, exercise = TRUE, exercise.eval = TRUE}
gapminder2002 <- filter(gapminder, year == 2002)[1:2, ]

gapminder2002A <- select(gapminder2002, country, continent)
gapminder2002B <- select(gapminder2002, country, year)
```

```{r ex12-solution}
gapminder2002A <- select(gapminder2002, country, continent)
gapminder2002B <- select(gapminder2002, country, year)

gapminder2002AB <- left_join(gapminder2002A, gapminder2002B)
```
